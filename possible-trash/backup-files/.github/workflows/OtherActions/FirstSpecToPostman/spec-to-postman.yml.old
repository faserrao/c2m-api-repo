name: ðŸ”„ Spec â†’ Collection â†’ Tests â†’ Docs

on:
  pull_request:
    paths: [ "openapi/**.yaml" ]
  push:
    branches: [ main ]

jobs:
  pipeline:
    runs-on: ubuntu-latest
    env:
      jwtToken: ${{ secrets.JWT_TOKEN || 'dummy-jwt' }}
    steps:
      - uses: actions/checkout@v3

      # 1. Lint / diff
      - uses: stoplight/spectral-action@v0
        with:
          file_glob: openapi/c2m_openapi.yaml
          spectral_ruleset: .spectral.yaml
      - uses: phoenix-actions/openapi-diff@v2
        with:
          base: main
          head: ${{ github.sha }}
          spec-path: openapi/c2m_openapi.yaml
          fail-on-breaking: true

      # 2. Generate Postman collection from spec
      - run: |
          npx @apideck/postman-generator generate \
            -f openapi/c2m_openapi.yaml \
            -o postman/generated/collection.json \
            --postman-compat

      # 3. Merge overrides
      - run: node scripts/merge-postman.js \
             postman/generated/collection.json \
             postman/custom/overrides.json \
             > postman/generated/collection.merged.json

      # 4. Newman tests + HTML
      - run: |
          npm install -g newman newman-reporter-html
          mkdir -p tests
          newman run postman/generated/collection.merged.json \
            --env-var jwtToken=$jwtToken \
            --env-var baseUrl=http://localhost:4000 \
            --reporters cli,html \
            --reporter-html-export tests/newman.html

      # 5. Schemathesis coverage (optional)
      - run: |
          pip install schemathesis
          schemathesis run openapi/c2m_openapi.yaml \
            --base-url http://localhost:4000 \
            --report tests/schemathesis.html

      - uses: actions/upload-artifact@v3
        with:
          name: reports
          path: tests

      # 6. Static docs build (Swagger/ReDoc)
      - run: |
          mkdir -p docs
          cp openapi/c2m_openapi.yaml docs/c2m_openapi_spec_final.yaml
          cp docs-templates/swagger.html docs/
          cp docs-templates/redoc.html   docs/
          cp docs-templates/index.html   docs/

      # 7. Deploy docs to gh-pages (main only)
      - if: github.ref == 'refs/heads/main'
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs

