# Postman Directory

This directory contains Postman collections, environments, scripts, and related artifacts for testing and developing the C2M API.

## Directory Structure

```
postman/
├── generated/                    # Auto-generated collections
│   ├── c2mapiv2-collection.json # Base collection from OpenAPI
│   ├── c2mapiv2-collection-with-tests.json # Collection with tests
│   └── various other versions   # Different processing stages
├── custom/                      # User customizations
│   └── overrides.json          # Custom overrides for collections
├── scripts/                     # Postman pre-request/test scripts
│   └── jwt-pre-request.js      # JWT token auto-refresh script
├── postman_api_uid.txt         # API definition UID
├── postman_env_uid.txt         # Environment UID
├── postman_mock_uid.txt        # Mock server UID
├── postman_mock_url.txt        # Mock server URL
├── prism_mock_url.txt          # Local Prism mock URL
└── various .json files         # Payloads, responses, configs
```

## Key Files

### Generated Collections

#### `generated/c2mapiv2-collection.json`
Base Postman collection generated from OpenAPI specification.
- **Generated by**: `make postman-import-openapi`
- **Purpose**: Raw import from OpenAPI spec

#### `generated/c2mapiv2-collection-with-tests.json`
Enhanced collection with automated tests.
- **Generated by**: `make postman-collection-add-tests`
- **Tests**: Response validation, status checks, schema validation
- **Coverage**: All endpoints with example data

#### `generated/c2mapiv2-collection-randomized.json`
Collection with randomized test data.
- **Generated by**: `make postman-collection-randomize`
- **Purpose**: Testing with varied inputs

### Configuration Files

#### `custom/overrides.json`
Custom configuration overrides for collection generation.
- **Purpose**: Customize generated collections
- **Usage**: Applied during collection processing

#### `scripts/jwt-pre-request.js`
Pre-request script for JWT authentication.
- **Purpose**: Automatic token refresh
- **Features**: 
  - Checks token expiration
  - Requests new short-term token
  - Updates collection variables

### Tracking Files

- **`postman_api_uid.txt`** - Postman API definition identifier
- **`postman_env_uid.txt`** - Environment UID for variables
- **`postman_mock_uid.txt`** - Cloud mock server identifier
- **`postman_mock_url.txt`** - Cloud mock server base URL
- **`prism_mock_url.txt`** - Local Prism mock server URL

## Workflows

### 1. Basic Collection Generation
```bash
# Import OpenAPI spec to Postman
make postman-import-openapi

# Add tests to collection
make postman-collection-add-tests

# Fix URLs to use {{baseUrl}}
make postman-fix-urls
```

### 2. Complete Build and Test
```bash
# Run full pipeline
make postman-collection-build-and-test
```

### 3. Mock Server Testing
```bash
# Test against local Prism mock
make prism-mock-test

# Test against Postman cloud mock
make postman-mock
```

### 4. JWT Authentication Setup
```bash
# Add JWT tests and scripts
make postman-add-jwt-tests
```

## Environment Variables

The Postman environment includes:
- `baseUrl` - API base URL (mock or production)
- `token` - Current JWT token
- `tokenExpiry` - Token expiration timestamp
- `clientId` - OAuth client ID
- `clientSecret` - OAuth client secret

## Collection Features

### Pre-request Scripts
- Automatic JWT token refresh
- Dynamic variable generation
- Request timestamp injection

### Test Scripts
- Response status validation
- Schema compliance checking
- Business logic validation
- Performance assertions

### Example Requests
Each endpoint includes:
- Success examples (200/201)
- Error examples (400/401/403)
- Edge case scenarios

## Testing Strategies

### 1. Local Development
```bash
# Start local mock
make prism-start

# Run tests
make prism-mock-test
```

### 2. Cloud Testing
```bash
# Create/update cloud mock
make postman-mock-create

# Run cloud tests
make postman-mock
```

### 3. Newman CLI Testing
```bash
# Run collection with Newman
make postman-test-collection
```

## Debugging

### Common Issues

1. **URL Problems**
   - Run `make postman-fix-urls` to fix hardcoded URLs
   - Check `{{baseUrl}}` variable is set

2. **Authentication Failures**
   - Verify JWT pre-request script is present
   - Check token hasn't expired
   - Ensure client credentials are correct

3. **Test Failures**
   - Review `newman-report.html` for details
   - Check response schemas match expectations
   - Verify mock data is up-to-date

### Debug Files
- `import-api-debug.json` - API import debugging
- `mock-validate.json` - Mock validation results
- `prism-mock-test-results.json` - Test execution details

## Best Practices

1. **Always use variables** for URLs and credentials
2. **Version control** generated collections
3. **Document custom changes** in overrides.json
4. **Test locally** before cloud deployment
5. **Keep tests idempotent** and isolated

## Integration Points

- **OpenAPI Spec**: Source of truth at `openapi/c2mapiv2-openapi-spec-final.yaml`
- **Makefile**: Orchestrates all Postman operations
- **CI/CD**: GitHub Actions automate collection updates
- **Documentation**: Syncs with API docs in `docs/`

## Related Documentation

- [OpenAPI Specification](../openapi/README.md)
- [Scripts Documentation](../scripts/README.md)
- [Root README](../README.md#postman-integration-guide)